<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GAME</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script type="text/javascript" src="../Logic/jquery-1.11.0.min.js"></script>
    <script src="Phaser/phaser.min.js"></script>
    <link rel="stylesheet" href="../CSS/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script type="text/javascript" src="qrcode.js"></script>
    <script src="../Logic/connect.js"></script>
    <!--QR-->
    <link rel="stylesheet" type="text/css" href="style.css">

    <script type="text/javascript">
        var webSocket = {};
        var obj;
        var element;
        var cursor = "";
        var audio = new Audio("../Assets/music/intro_sfx.mp3");
        audio.addEventListener(
            'ended',
            function () {
                this.currentTime = 0;
                this.play();
            },
            false);

        var config = {
            type: Phaser.AUTO,
            width: 1920,
            height: 1080,
            parent: "container",
            type: Phaser.AUTO,
            physics: {
                default: 'arcade',
                arcade: {
                    enableSleeping: true,
                    debug: true,
                    gravity: {
                        y: 0
                    }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        }
        var game = new Phaser.Game(config);

        function preload() {

            this.load.image('ball', "https://i.ibb.co/ysDLXnQ/ball.png");
		    this.load.image('hole', "https://i.ibb.co/KhPZ5V1/hole.png");
		    this.load.image('element-w', "https://i.ibb.co/vP2RVp3/element-w.png");
		    this.load.image('element-h', "https://i.ibb.co/1r5TydL/element-h.png");
		    this.load.image('panel', "https://i.ibb.co/7rTw4rS/panel.png");
            this.load.image('button-pause', "https://i.ibb.co/6NtmT3y/button-pause.png");
            this.load.image('screen-bg', "https://i.ibb.co/X4kRSYt/screen-bg.png");
		    this.load.image('screen-mainmenu', "https://i.ibb.co/5KmrknM/screen-mainmenu.png");
		    //this.load.image('screen-howtoplay', "../Assets/orb_game/screen-howtoplay.png");
		    this.load.image('border-horizontal', "https://i.ibb.co/CMC2Vmk/border-horizontal.png");
		    this.load.image('border-vertical', "https://i.ibb.co/gVmfvxW/border-vertical.png");

		    //this.load.spritesheet('button-audio', "../Assets/img/orb_game/button-audio.png", 35, 35);
		    //this.load.spritesheet('button-start', "../Assets/img/orb_game/button-start.png", 146, 51);    
        }

        function release() {}

        var hp;
        var bar;

        //Sprites
        var ball;
        var hole;
        var panel;
        var pauseButton;
        var screen_bg;

        function create() {

            //this.game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
		    //this.game.scale.pageAlignHorizontally = true;
		    //this.game.scale.pageAlignVertically = true;
            
            screen_bg = this.add.image(960, 540, 'screen-bg');
            screen_bg.setScale(2.25);

            //screen_bg = this.add.sprite(0, 0, 'screen-bg');

            panel = this.add.image(960, 58.25, 'panel');
            panel.setScale(2.25);

            //panel = this.add.sprite(0, 0, 'panel');
            physics.startSystem(Phaser.Physics.ARCADE);
            fontSmall = { font: "16px Arial", fill: "#FFFFFF " };
            fontBig = { font: "24px Arial", fill: "#FFFFFF " };
            fontMessage = { font: "24px Arial", fill: "#FFFFFF ",  align: "center", stroke: "#320C3E", strokeThickness: 4 };
            timer = 0;
            totalTimer = 0;
            level = 1;
            maxLevels = 5;
            movementForce = 10;
            ballStartPos = { x: Ball._WIDTH*0.5, y: 450 };
            

            pauseButton = this.add.button(Ball._WIDTH-8, 8, 'button-pause', managePause, this);
            pauseButton.anchor.set(1,0);
            pauseButton.input.useHandCursor = true;
            timerText = this.add.text(600, 15, "Tiempo: "+timer, fontBig);
            levelText = this.add.text(150, 10, "Nivel: "+level+" / "+maxLevels, fontSmall);
            totalTimeText = this.add.text(150, 30, "Tiempo total: "+totalTimer, fontSmall);

            hole = this.add.sprite(960, 540, 'hole');
            physics.enable(hole, Phaser.Physics.ARCADE);
            hole.anchor.set(0.5);
            hole.body.setSize(2, 2);
            
            ball = this.add.sprite(this.ballStartPos.x, this.ballStartPos.y, 'ball');
            ball = this.add.sprite(ballStartPos.x, ballStartPos.y, 'ball');
            ball.anchor.set(0.5);
            physics.enable(ball, Phaser.Physics.ARCADE);
            ball.body.setSize(18, 18);
            ball.body.bounce.set(0.3, 0.3);

            initLevels();
		    showLevel(1);
            keys = this.input.keyboard.createCursorKeys();

            // Ball._player = ball;

            gyro.frequency = 20;
            gyro.startTracking(function(o) {
                Ball._player.body.velocity.x += o.gamma;
                Ball._player.body.velocity.y += o.beta;
            });
            

            time.events.loop(Phaser.Timer.SECOND, updateCounter, this);

            borderGroup = this.add.group();
            borderGroup.enableBody = true;
            borderGroup.physicsBodyType = Phaser.Physics.ARCADE;
            borderGroup.create(0, 50, 'border-horizontal');
            borderGroup.create(0, Ball._HEIGHT-2, 'border-horizontal');
            borderGroup.create(0, 0, 'border-vertical');
            borderGroup.create(Ball._WIDTH-2, 0, 'border-vertical');
            borderGroup.setAll('body.immovable', true);

        }

        function initLevels(){
		    levels = [];
		    levelData = [
			[
				{ x: 96, y: 224, t: 'w' }
			],
			[
				{ x: 72, y: 320, t: 'w' },
				{ x: 200, y: 320, t: 'h' },
				{ x: 72, y: 150, t: 'w' }
			],
			[
				{ x: 64, y: 352, t: 'h' },
				{ x: 224, y: 352, t: 'h' },
				{ x: 0, y: 240, t: 'w' },
				{ x: 128, y: 240, t: 'w' },
				{ x: 200, y: 52, t: 'h' }
			],
			[
				{ x: 78, y: 352, t: 'h' },
				{ x: 78, y: 320, t: 'w' },
				{ x: 0, y: 240, t: 'w' },
				{ x: 192, y: 240, t: 'w' },
				{ x: 30, y: 150, t: 'w' },
				{ x: 158, y: 150, t: 'w' }
			],
			[
				{ x: 188, y: 352, t: 'h' },
				{ x: 92, y: 320, t: 'w' },
				{ x: 0, y: 240, t: 'w' },
				{ x: 128, y: 240, t: 'w' },
				{ x: 256, y: 240, t: 'h' },
				{ x: 180, y: 52, t: 'h' },
				{ x: 52, y: 148, t: 'w' }
			]
		];
		for(var i=0; i<this.maxLevels; i++) {
			var newLevel = this.add.group();
			newLevel.enableBody = true;
			newLevel.physicsBodyType = Phaser.Physics.ARCADE;
			for(var e=0; e<this.levelData[i].length; e++) {
				var item = this.levelData[i][e];
				newLevel.create(item.x, item.y, 'element-'+item.t);
			}
			newLevel.setAll('body.immovable', true);
			newLevel.visible = false;
			this.levels.push(newLevel);
		}
	    }

        function showLevel(level) {
		var lvl = level | this.level;
		if(this.levels[lvl-2]) {
			this.levels[lvl-2].visible = false;
		}
		this.levels[lvl-1].visible = true;
	    }

        function updateCounter() {
		this.timer++;
		this.timerText.setText("Tiempo: "+this.timer);
		this.totalTimeText.setText("Tiempo total: "+(this.totalTimer+this.timer));
	    }

	    function managePause() {
		this.game.paused = true;
		var pausedText = this.add.text(Ball._WIDTH*0.5, 250, "Juego pausado,\ntoca para continuar.", this.fontMessage);
		pausedText.anchor.set(0.5);
		this.input.onDown.add(function(){
			pausedText.destroy();
			this.game.paused = false;
		}, this);
	    }

        function update() {
		if(this.keys.left.isDown) {
			this.ball.body.velocity.x -= this.movementForce;
		}
		else if(this.keys.right.isDown) {
			this.ball.body.velocity.x += this.movementForce;
		}
		if(this.keys.up.isDown) {
			this.ball.body.velocity.y -= this.movementForce;
		}
		else if(this.keys.down.isDown) {
			this.ball.body.velocity.y += this.movementForce;
		}
		this.physics.arcade.collide(this.ball, this.borderGroup, this.wallCollision, null, this);
		this.physics.arcade.collide(this.ball, this.levels[this.level-1], this.wallCollision, null, this);
		this.physics.arcade.overlap(this.ball, this.hole, this.finishLevel, null, this);
	    }

        function finishLevel() {
		if(this.level >= this.maxLevels) {
			this.totalTimer += this.timer;
			alert('Felicidades, juego completado!\nTiempo total de juego: '+this.totalTimer+' segundos!');
			this.game.state.start('MainMenu');
		}
		else {
			alert('Felicidades, nivel '+this.level+' completado!');
			this.totalTimer += this.timer;
			this.timer = 0;
			this.level++;
			this.timerText.setText("Tiempo: "+this.timer);
			this.totalTimeText.setText("Tiempo total: "+this.totalTimer);
			this.levelText.setText("Nivel: "+this.level+" / "+this.maxLevels);
			this.ball.body.x = this.ballStartPos.x;
			this.ball.body.y = this.ballStartPos.y;
			this.ball.body.velocity.x = 0;
			this.ball.body.velocity.y = 0;
			this.showLevel();
		}
	    }

        function render() {
	    }


    </script>
</head>

<body>
</body>

</html>